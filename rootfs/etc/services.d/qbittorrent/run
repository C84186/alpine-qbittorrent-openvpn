#!/usr/bin/with-contenv sh

CONFIG_FILE=${CONFIG_DIR}/qBittorrent/config/qBittorrent.conf
export QBT_PROFILE=${CONFIG_DIR}

# wait for VPN connection
until ifconfig | grep tun | grep -q "00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00"; do
    sleep 0.5
done

# drop rule allowing DNS traffic outside VPN tunnel
iptables -D OUTPUT -p udp -d ${DNS} --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -D INPUT -p udp -s ${DNS} --sport 53 -m state --state ESTABLISHED -j ACCEPT
iptables -D OUTPUT -p tcp -d ${DNS} --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -D INPUT -p tcp -s ${DNS} --sport 53 -m state --state ESTABLISHED -j ACCEPT

exec s6-setuidgid ${PUID}:${PGID} qbittorrent-nox
