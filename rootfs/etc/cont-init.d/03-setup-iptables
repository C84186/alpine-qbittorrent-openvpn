#!/usr/bin/with-contenv sh

# extract docker network CIDR notation
DECTECTED_DOCKER_CIDR=$(ip -o -f inet addr show | awk '/scope global/ {print $4}')

# fallback to DOCKER_CIDR if no DECTECTED_DOCKER_CIDR
DOCKER_CIDR=${DECTECTED_DOCKER_CIDR:-DOCKER_CIDR}

# extract VPN protocol, host and port from configuration
VPN_PROTO=$(awk '/proto / { print $2 }' "${OPENVPN_CONFIG_FILE}")
VPN_HOST=$(awk '/remote / { print $2 }' "${OPENVPN_CONFIG_FILE}")
VPN_PORT=$(awk '/remote / { print $3 }' "${OPENVPN_CONFIG_FILE}")

DNS_SERVER=$(sed -n -e 's/^.*nameserver //p' /etc/resolv.conf)

# Check that VPN information was sucessfully extracted from configuration
if [[ -z "${VPN_PROTO}" || -z "${VPN_HOST}" || -z "${VPN_PORT}" ]]; then
    echo "One of the following variables could not be detected in the VPN configuration:
    VPN_PROTO:  $VPN_PROTO
    VPN_HOST:   $VPN_HOST
    VPN_PORT:   $VPN_PORT
    "
    exit 1
fi

# reset iptables
iptables --flush
iptables --delete-chain
iptables -t nat --flush
iptables -t nat --delete-chain

# Set default policies to drop all communication unless specifically allowed
iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP

# allow localhost traffic
iptables -A INPUT -j ACCEPT -i lo
iptables -A OUTPUT -j ACCEPT -o lo

# allow DNS traffic outside VPN tunnel with given DNS resolver only on UDP and DNS port
# 127.0.0.11 is the IP of the default docker DNS if it is not set, since the destination port changes on every start
# I have not yet found an alternative to just allowing all outboung UDP trafffic to this IP
# see: https://serverfault.com/a/826424
if [ "${DNS_SERVER}" == "127.0.0.11" ]; then
    iptables -A OUTPUT -p udp -d ${DNS_SERVER} -m state --state NEW,ESTABLISHED -j ACCEPT
    iptables -A INPUT -p udp -s ${DNS_SERVER} -m state --state ESTABLISHED -j ACCEPT
    iptables -A OUTPUT -p tcp -d ${DNS_SERVER} -m state --state NEW,ESTABLISHED -j ACCEPT
    iptables -A INPUT -p tcp -s ${DNS_SERVER} -m state --state ESTABLISHED -j ACCEPT
    iptables -I FORWARD -s ${DNS_SERVER} -j ACCEPT
else
    # NOTE: these rules are dropped before starting qbittorrent
    iptables -A OUTPUT -p udp -d ${DNS_SERVER} --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
    iptables -A INPUT -p udp -s ${DNS_SERVER} --sport 53 -m state --state ESTABLISHED -j ACCEPT
    iptables -A OUTPUT -p tcp -d ${DNS_SERVER} --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
    iptables -A INPUT -p tcp -s ${DNS_SERVER} --sport 53 -m state --state ESTABLISHED -j ACCEPT
fi

# allow LAN traffic
iptables -A INPUT --src ${LAN} -j ACCEPT -i eth+
iptables -A OUTPUT -d ${LAN} -j ACCEPT -o eth+

# allow traffic with other containers on docker network
iptables -A INPUT --src ${DOCKER_CIDR} -j ACCEPT -i eth+
iptables -A OUTPUT -d ${DOCKER_CIDR} -j ACCEPT -o eth+

# allow traffic with VPN host over VPN's port and with VPN's protocol
iptables -A OUTPUT -j ACCEPT -d ${VPN_HOST} -o eth+ -p ${VPN_PROTO} -m ${VPN_PROTO} --dport ${VPN_PORT}
iptables -A INPUT -j ACCEPT -s ${VPN_HOST} -i eth+ -p ${VPN_PROTO} -m ${VPN_PROTO} --sport ${VPN_PORT}

# allow traffic through VPN tunnel interface
iptables -A INPUT -j ACCEPT -i tun+
iptables -A OUTPUT -j ACCEPT -o tun+
