stages:
  - build

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1
  DOCKER_CLI_EXPERIMENTAL: enabled
  BUILDX_URL: https://github.com/docker/buildx/releases/latest/download/buildx-v0.4.1.linux-amd64
  BUILDX_BUILDER: builder
  BUILDX_PLATFORM: linux/amd64,linux/386,linux/arm64,linux/arm/v7,linux/arm/v6,linux/ppc64le

build-containers:
  # Official docker image.
  image: docker:latest
  stage: build
  services:
    - name: "docker:dind"
      command: ["--experimental"]
  before_script:
    - /bin/sh build/prepare_builder.sh
  script:
    - /bin/sh build/build.sh
  only:
    refs:
      - master
    changes:
      - Dockerfile
      - etc/*
      - .gitlab-ci.yml
      - build/*
